{% extends 'base.html' %}
{% load sass_tags %}
{% load static %}
{% load carts_tags %}

{% block css %}
  <link rel="stylesheet" href="{% sass_src 'deps/css/orders.scss' %}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.5.0/build/css/intlTelInput.css">
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.5.0/build/js/intlTelInput.min.js"></script>
<script src="{% static 'deps/js/phone-input.js' %}"></script>
<script src="{% static 'deps/js/orders.js' %}"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{% static 'deps/js/order-delivery-map.js' %}"></script>
{% endblock %}

{% block content %}
  <main class="checkout-main">
    <div class="checkout-container">
      <div class="checkout-header">
        <h1 data-translate="checkout_title">Checkout</h1>
        <p data-translate="checkout_subtitle">Review your order and complete your purchase</p>
      </div>

      <div class="checkout-content">
        <div class="checkout-card">
          <div class="checkout-title">
            <h2 data-translate="order_summary">Order Summary</h2>
          </div>
          
          {% user_carts request as carts %}
          <div class="order-items">
            {% for cart in carts %}
              <div class="order-item">
                <div class="item-info">
                  <div class="item-name product-name" data-name-ru="{{ cart.product.name_ru }}" data-name-en="{{ cart.product.name_en }}">{{ cart.product.name_en }}</div>
                  <div class="item-quantity"><span data-translate="quantity">Quantity:</span> {{ cart.quantity }}</div>
                </div>
                <div class="item-total">${{ cart.product.sell_price }}</div>
              </div>
            {% empty %}
              <p class="empty-cart-message" data-translate="your_cart_empty">Your cart is empty</p>
            {% endfor %}
          </div>
          {% if carts %}
            <div class="order-total">
              <span class="total-label" data-translate="total">Total:</span>
              <span class="whats-wrong"><span data-translate="whats_wrong">What's wrong?</span> <a href="{% url 'users:profile' %}" data-translate="change_it_here">You can change it here</a></span>
              <span class="total-amount">${{ total_price }}</span>
            </div>
          {% endif %}
        </div>

        <div class="checkout-card">
          <div class="checkout-title">
            <h2 data-translate="shipping_payment">Shipping & Payment</h2>
          </div>

          <form action="{% url 'orders:create_order' %}" method="post" class="checkout-form">
            {% csrf_token %}

            <div class="form-section">
              <div class="section-label" data-translate="personal_info">Personal Information</div>
              
              <div class="form-grid">
                <div class="form-field">
                  <label for="id_first_name" data-translate="first_name">First Name*</label>
                  <input 
                    type="text" 
                    id="id_first_name" 
                    name="first_name" 
                    placeholder="John"
                    value="{% if form.first_name.value %}{{ form.first_name.value }}{% endif %}"
                    required>
                  {% if form.first_name.errors %}
                    <div class="field-error">
                      {% for error in form.first_name.errors %}
                        {{ error }}<br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="form-field">
                  <label for="id_last_name" data-translate="last_name">Last Name*</label>
                  <input 
                    type="text" 
                    id="id_last_name" 
                    name="last_name" 
                    placeholder="Doe"
                    value="{% if form.last_name.value %}{{ form.last_name.value }}{% endif %}"
                    required>
                  {% if form.last_name.errors %}
                    <div class="field-error">
                      {% for error in form.last_name.errors %}
                        {{ error }}<br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="form-field form-field-full">
                  <label for="id_phone_number" data-translate="phone_number">Phone Number*</label>
                  <input 
                    type="text" 
                    id="id_phone_number" 
                    name="phone_number" 
                    placeholder="1234567890"
                    value="{% if form.phone_number.value %}{{ form.phone_number.value }}{% endif %}"
                    required>
                  {% if form.phone_number.errors %}
                    <div class="field-error">
                      {% for error in form.phone_number.errors %}
                        {{ error }}<br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-label" data-translate="delivery_method">Delivery Method</div>
              
              <div class="radio-group">
                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="requires_delivery" 
                    value="1" 
                    checked>
                  <label class="radio-label" data-translate="delivery_address_opt">Delivery to Address</label>
                </label>

                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="requires_delivery" 
                    value="0">
                  <label class="radio-label" data-translate="pickup_store">Pickup in Store</label>
                </label>
              </div>

              <div class="form-field form-field-full optional-field" id="deliveryAddressField">
                <label for="id_delivery_address" class='section-label' data-translate="delivery_address">Адрес доставки*</label>
                
                <div class="delivery-map-container">
                  <div class="map-controls">
                    <input 
                      type="text" 
                      id="addressSearchInput" 
                      class="address-search-input" 
                      placeholder="Enter address or coordinates"
                      data-translate="search_placeholder_map">
                    <button type="button" id="searchAddressBtn" class="search-address-btn" data-translate="search_address">Search</button>
                  </div>
                  
                  <div id="deliveryMap" class="delivery-map"></div>
                  
                  <div class="map-hint" data-translate="click_on_map">Search address or click on map to select location</div>
                </div>
                
                <input 
                  type="text" 
                  id="id_delivery_address" 
                  name="delivery_address" 
                  placeholder="Your selected address will appear here"
                  class="address-display-input"
                  data-translate="address_placeholder"
                  value="{% if form.delivery_address.value %}{{ form.delivery_address.value }}{% endif %}"
                  readonly>
                {% if form.delivery_address.errors %}
                  <div class="field-error">
                    {% for error in form.delivery_address.errors %}
                      {{ error }}<br>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="form-grid optional-field" id="zipCodeField">
                <div class="form-field">
                  <label for="id_zip_code" data-translate="zip_code">Zip Code*</label>
                  <input 
                    type="text" 
                    id="id_zip_code" 
                    name="zip_code" 
                    placeholder="12345"
                    value="{% if form.zip_code.value %}{{ form.zip_code.value }}{% endif %}">
                  {% if form.zip_code.errors %}
                    <div class="field-error">
                      {% for error in form.zip_code.errors %}
                        {{ error }}<br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="form-field">
                  <label for="id_house_number" data-translate="house_number">House Number/Apt*</label>
                  <input 
                    type="text" 
                    id="id_house_number" 
                    name="house_number" 
                    placeholder="Apt 101, Suite A"
                    value="{% if form.house_number.value %}{{ form.house_number.value }}{% endif %}">
                  {% if form.house_number.errors %}
                    <div class="field-error">
                      {% for error in form.house_number.errors %}
                        {{ error }}<br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-label" data-translate="payment_method">Payment Method</div>
              
              <div class="radio-group">
                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="payment_on_get" 
                    value="0" 
                    checked>
                  <label class="radio-label" data-translate="credit_card">Credit/Debit Card</label>
                </label>

                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="payment_on_get" 
                    value="1">
                  <label class="radio-label" data-translate="cash_on_delivery">Cash/Card on Delivery</label>
                </label>
              </div>
              {% if form.payment_on_get.errors %}
                <div class="field-error">
                  {% for error in form.payment_on_get.errors %}
                    {{ error }}<br>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            {% if form.non_field_errors %}
              <div class="form-section">
                <div class="field-error">
                  {% for error in form.non_field_errors %}
                    {{ error }}<br>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <button type="submit" class="checkout-button" data-translate="complete_order" {% if not carts %}disabled{% endif %}>Complete Order</button>
          </form>
        </div>
      </div>
    </div>
  </main>
{% endblock %}
